<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CanlÄ± Masa Tenisi TurnuvasÄ±</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --light: #ecf0f1; --danger: #e74c3c; --vote: #f39c12; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background: #f0f2f5; color: #333; padding-bottom: 60px; }
        
        /* Navbar */
        .navbar { background: var(--primary); display: flex; justify-content: space-around; padding: 0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .navbar button { flex: 1; padding: 15px; background: transparent; border: none; color: #bdc3c7; font-size: 11px; font-weight: bold; cursor: pointer; transition: 0.3s; border-bottom: 4px solid transparent; }
        .navbar button.active { color: white; border-bottom: 4px solid var(--accent); background: rgba(255,255,255,0.05); }

        /* Container */
        .container { max-width: 800px; margin: 0 auto; padding: 15px; }
        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }

        /* Sub-Navbar (Ortak KullanÄ±m) */
        .sub-navbar { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; background: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .sub-tab-btn { flex: 1; padding: 8px; border: 1px solid #ddd; background: #f9f9f9; color: #555; border-radius: 5px; cursor: pointer; font-size: 11px; font-weight: bold; transition: all 0.2s; text-transform: uppercase; }
        .sub-tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* Tablo */
        .table-container { overflow-x: auto; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); background: white; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 350px; }
        th, td { padding: 12px 8px; text-align: center; border-bottom: 1px solid #eee; font-size: 14px; }
        th { background: var(--primary); color: white; font-weight: 600; font-size: 12px; letter-spacing: 0.5px; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .top8 { background-color: #e8f5e9 !important; } 
        .top8 td:first-child { border-left: 4px solid var(--accent); font-weight: bold; color: var(--accent); }

        /* Ã‡ekilen Oyuncu SatÄ±rÄ± (Siyah Arka Plan) */
        .withdrawn-row { background-color: black !important; color: #bdc3c7 !important; }
        .withdrawn-row td { border-bottom: 1px solid #444; }
        
        /* FikstÃ¼r KartlarÄ± */
        .day-header { text-align: center; margin: 25px 0 10px; font-weight: 800; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; font-size: 13px; position: relative; }
        .day-header::after { content: ''; display: block; width: 40px; height: 3px; background: var(--accent); margin: 5px auto 0; border-radius: 2px; }
        
        /* GÃœNCELLENEN OYUNCU BAÅLIÄI (TOGGLE) */
        .player-header { 
            background: var(--primary); color: white; padding: 12px 15px; margin: 10px 0 2px 0; 
            border-radius: 5px; font-weight: bold; text-align: left; font-size: 14px; 
            display: flex; justify-content: space-between; align-items: center; cursor: pointer;
            transition: background 0.2s; user-select: none;
        }
        .player-header:hover { background: #34495e; }
        .player-header .arrow { transition: transform 0.3s ease; font-size: 10px; }
        .player-header.active .arrow { transform: rotate(180deg); }
        
        /* Ã‡ekilme Butonu (Player Header Ä°Ã§inde) */
        .withdraw-btn {
            background: var(--danger); color: white; border: none; padding: 4px 8px; 
            border-radius: 4px; font-size: 10px; cursor: pointer; margin-right: 10px;
            font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .withdraw-btn.active { background: #555; color: #bbb; border: 1px solid #777; }

        /* GÄ°ZLÄ° MAÃ‡ LÄ°STESÄ° */
        .player-matches-container { display: none; padding-top: 5px; animation: slideDown 0.3s ease; }
        
        .match-card { background: white; padding: 12px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; }
        
        /* Player AlanÄ± ve Oy OranlarÄ± */
        .player-container { width: 35%; display: flex; align-items: center; justify-content: space-between; }
        .player-container.left { flex-direction: row; text-align: left; }
        .player-container.right { flex-direction: row-reverse; text-align: right; }

        .player { font-weight: 600; font-size: 13px; word-wrap: break-word; line-height: 1.2; transition: color 0.3s; width: 100%; }
        
        /* GÃ¼ncellenen Oy Kutusu Stili */
        .vote-ratio { 
            font-size: 11px; color: #333; font-weight: bold; 
            background: #f0f2f5; padding: 4px 6px; border-radius: 4px; 
            min-width: 35px; text-align: center; line-height: 1.1; 
        }
        
        /* Skor AlanÄ± - GeniÅŸlik esnek yapÄ±ldÄ± */
        .scores { display: flex; align-items: center; gap: 5px; justify-content: center; width: auto; min-width: 120px; }
        .scores input { width: 30px; height: 30px; text-align: center; font-size: 16px; border: 1px solid #ddd; border-radius: 4px; font-weight: bold; background: #f9f9f9; }
        .scores input:focus { outline: none; border-color: var(--accent); background: white; }
        .scores input:disabled { background: #eee; color: #333; border: none; }

        /* Oylama ButonlarÄ± */
        .vote-btn { 
            background: white; border: 1px solid #ddd; border-radius: 20px; 
            padding: 5px 10px; font-size: 12px; cursor: pointer; color: #555; 
            display: flex; align-items: center; gap: 5px; transition: 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .vote-btn:hover { background: #f9f9f9; border-color: var(--vote); color: var(--vote); }
        .vote-btn.voted { background: var(--vote); color: white; border-color: var(--vote); pointer-events: none; }
        
        /* HÃ¼kmen Butonu */
        .hukmen-toggle { 
            width: 24px; height: 24px; border-radius: 4px; border: 1px solid #ccc; 
            color: #777; font-size: 10px; font-weight: bold; display: flex; 
            align-items: center; justify-content: center; cursor: pointer; 
            margin-left: 8px; user-select: none; background: #fff; transition: all 0.2s; flex-shrink: 0;
        }
        .hukmen-toggle:hover { background: #f0f0f0; }
        .hukmen-toggle.active { background: var(--danger); color: white; border-color: var(--danger); }
        .hukmen-indicator { font-size: 10px; color: var(--danger); font-weight: bold; margin-left: 5px; }

        /* Admin & Rules Box */
        .admin-box, .rules-box { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .admin-box { text-align: center; }
        .rules-box { text-align: left; line-height: 1.6; color: #444; }
        
        /* Kurallar Listesi */
        .rules-box h3 { color: var(--accent); margin-top: 20px; font-size: 16px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .rules-box ul { margin: 10px 0; padding-left: 20px; }
        .rules-box li { margin-bottom: 5px; font-size: 14px; }

        .admin-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 5px; text-transform: uppercase; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-danger { background: var(--danger); color: white; margin-top: 20px; }
        .btn-secondary { background: #34495e; color: white; }
        .file-upload { background: #f1f1f1; padding: 15px; border-radius: 6px; margin-top: 15px; border: 2px dashed #ccc; }

        .status-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #333; color: white; padding: 12px; text-align: center; font-size: 13px; z-index: 2000; display: none; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 600px) { 
            .player { font-size: 12px; } 
            .vote-ratio { font-size: 10px; min-width: 30px; padding: 3px; }
            .navbar button { font-size: 10px; padding: 12px 5px; }
        }
    </style>
</head>
<body>

<div class="navbar">
    <button class="tab-link active" onclick="openTab('puanDurumu')">PUAN DURUMU</button>
    <button class="tab-link" onclick="openTab('fikstur')">FÄ°KSTÃœR</button>
    <button class="tab-link" onclick="openTab('oylama')">MAÃ‡LARI OYLA</button>
    <button class="tab-link" onclick="openTab('kurallar')">KURALLAR</button>
    <button class="tab-link" onclick="openTab('admin')">YÃ–NETÄ°CÄ°</button>
</div>

<div class="container">
    <div id="loading" class="loader"></div>

    <div id="puanDurumu" class="tab-content" style="display:none;">
        
        <div class="sub-navbar">
            <button class="sub-tab-btn active" id="btnStandingsStandard" onclick="switchStandingsView('standard')">GENEL PUAN</button>
            <button class="sub-tab-btn" id="btnStandingsWeighted" onclick="switchStandingsView('weighted')">AÄIRLIKLI ORTALAMA</button>
        </div>

        <div id="standingsStandard">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th width="10%">#</th>
                            <th width="40%" style="text-align:left; padding-left:15px;">OYUNCU</th>
                            <th width="10%">O</th>
                            <th width="10%">G</th>
                            <th width="10%">M</th>
                            <th width="10%">AV</th>
                            <th width="10%">P</th>
                        </tr>
                    </thead>
                    <tbody id="standingsBody"></tbody>
                </table>
            </div>
            <p style="text-align:center; color:#7f8c8d; font-size:11px; margin-top:5px;">SÄ±ralama: Puan > Averaj > Ä°sim | G:2 Puan, M:1 Puan, HÃ¼kmen: 0 Puan</p>
        </div>

        <div id="standingsWeighted" style="display:none;">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th width="10%">#</th>
                            <th width="40%" style="text-align:left; padding-left:15px;">OYUNCU</th>
                            <th width="10%">O</th>
                            <th width="10%">P</th>
                            <th width="15%" style="background:#27ae60;">ORT</th>
                        </tr>
                    </thead>
                    <tbody id="weightedStandingsBody"></tbody>
                </table>
            </div>
            <p style="text-align:center; color:#7f8c8d; font-size:11px; margin-top:5px;">SÄ±ralama: (Toplam Puan / Oynanan MaÃ§)</p>
        </div>

    </div>

    <div id="fikstur" class="tab-content" style="display:none;">
        
        <div class="sub-navbar">
            <button class="sub-tab-btn active" id="btnDayView" onclick="switchFixtureView('day')">ğŸ“… GÃœN GÃ–RÃœNÃœMÃœ</button>
            <button class="sub-tab-btn" id="btnPlayerView" onclick="switchFixtureView('player')">ğŸ‘¤ OYUNCU GÃ–RÃœNÃœMÃœ</button>
        </div>

        <div id="fixtureByDay"></div>
        
        <div id="fixtureByPlayer" style="display:none;"></div>

        <div id="saveBtnArea" style="margin-top:20px; display:none; position:sticky; bottom:20px;">
            <button class="btn btn-primary" style="box-shadow: 0 4px 10px rgba(0,0,0,0.3);" onclick="saveDataToFirebase()">ğŸ’¾ SKORLARI KAYDET VE YAYINLA</button>
        </div>
    </div>

    <div id="oylama" class="tab-content" style="display:none;">
        <p style="text-align:center; color:#7f8c8d; font-size:13px; margin-bottom:20px;">
            Favori oyuncunuzu desteklemek iÃ§in maÃ§ kartlarÄ±ndaki butonlara tÄ±klayÄ±n.
        </p>
        <div id="votingList"></div>
    </div>

    <div id="kurallar" class="tab-content" style="display:none;">
        <div class="rules-box">
            <h2 style="color:var(--primary); text-align:center; margin-bottom: 20px; border-bottom: 2px solid var(--accent); padding-bottom:10px;">VESTEL MOBILITY <br> MASA TENÄ°SÄ° TURNUVASI</h2>
            
            <h3>1. Genel Kurallar</h3>
            <ul>
                <li>MaÃ§lar tekler (1'e 1) oynanÄ±r.</li>
                <li>MaÃ§lar 3 set Ã¼zerinden oynanÄ±r (2 set kazanan maÃ§Ä± kazanÄ±r).</li>
                <li>Setler 21 sayÄ±da biter.</li>
                <li>20-20 durumunda fark 2 olana kadar devam edilir.</li>
            </ul>
    
            <h3>2. Servis KurallarÄ±</h3>
            <ul>
                <li>Servis aÃ§Ä±k avuÃ§ iÃ§inden atÄ±lÄ±r.</li>
                <li>Top Ã¶nce servis atan sahaya, sonra rakip sahaya deÄŸmelidir.</li>
                <li>Fileye deÄŸip karÅŸÄ±ya geÃ§en servis tekrar edilir (let).</li>
                <li>Her 5 sayÄ±da bir servis deÄŸiÅŸir.</li>
                <li>20-20 sonrasÄ± servis her sayÄ±da bir deÄŸiÅŸir.</li>
            </ul>
    
            <h3>3. Oyun SÄ±rasÄ±nda</h3>
            <ul>
                <li>Top fileye deÄŸip karÅŸÄ± sahaya dÃ¼ÅŸerse oyun devam eder.</li>
                <li>Top arka arkaya iki kez rakete vurulamaz.</li>
                <li>Top el, kol veya vÃ¼cudun baÅŸka bir yerine deÄŸerse sayÄ± rakibe gider.</li>
                <li>Masaya elle veya vÃ¼cutla mÃ¼dahale yasaktÄ±r.</li>
            </ul>
    
            <h3>4. SayÄ± Rakibe Verilir EÄŸer;</h3>
            <ul>
                <li>Top masaya deÄŸmeden dÄ±ÅŸarÄ± giderse.</li>
                <li>Top fileye takÄ±lÄ±p karÅŸÄ±ya geÃ§mezse.</li>
                <li>Top iki kez kendi sahana deÄŸerse.</li>
                <li>Servis kurallara uygun atÄ±lmazsa.</li>
            </ul>
    
            <h3>5. Fair Play</h3>
            <ul>
                <li>Kararlarda saygÄ± ve dÃ¼rÃ¼stlÃ¼k esastÄ±r.</li>
                <li>Hakem yoksa oyuncular uzlaÅŸÄ±r.</li>
                <li>TartÄ±ÅŸmalarda turnuva sorumlusu karar verir.</li>
            </ul>
    
            <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">
    
            <h3 style="color:var(--primary);">FikstÃ¼r Ä°ÅŸleyiÅŸi</h3>
            <ul>
                <li>Galibiyet: <strong>2 Puan</strong>, MaÄŸlubiyet: <strong>1 Puan</strong>.</li>
                <li>HÃ¼kmen maÄŸlubiyet durumunda <strong>0 Puan</strong> verilir.</li>
                <li>Grup maÃ§larÄ± sonunda puan cetvelindeki <strong>ilk 8 oyuncu</strong> Play-off oynamaya hak kazanÄ±r.</li>
                <li>Puan eÅŸitliÄŸinde sÄ±rasÄ±yla; Genel Averaj ve Ä°sim SÄ±ralamasÄ± dikkate alÄ±nÄ±r.</li>
            </ul>
        </div>
    </div>

    <div id="admin" class="tab-content" style="display:none;">
        <div id="loginPanel" class="admin-box">
            <h2 style="color:var(--primary);">YÃ¶netici GiriÅŸi</h2>
            <input type="email" id="email" placeholder="E-Posta">
            <input type="password" id="password" placeholder="Åifre">
            <button class="btn btn-primary" onclick="login()">GiriÅŸ Yap</button>
        </div>

        <div id="adminControls" class="admin-box" style="display:none;">
            <h3 style="color:var(--accent); margin-top:0;">YÃ¶netim Paneli</h3>
            
            <div class="file-upload">
                <h4 style="margin:0 0 10px 0; color:#555;">Veri YÃ¶netimi</h4>
                
                <label style="font-size:12px; font-weight:bold; display:block; text-align:left; margin-bottom:5px;">Veri YÃ¼kle (Upload):</label>
                <input type="file" id="jsonFileInput" accept=".json" style="width:100%; margin-bottom:10px;">
                <button class="btn btn-secondary" onclick="importFromPythonJson()">ğŸ“‚ YÃœKLE VE YAYINLA</button>
                
                <hr style="border:0; border-top:1px dashed #eee; margin:15px 0;">
                
                <label style="font-size:12px; font-weight:bold; display:block; text-align:left; margin-bottom:5px;">Yedekle (Download):</label>
                <button class="btn btn-primary" onclick="downloadJsonData()">ğŸ’¾ GÃœNCEL VERÄ°YÄ° Ä°NDÄ°R (JSON)</button>
            </div>
            
            <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">
            
            <button class="btn btn-danger" onclick="firebase.auth().signOut()">Ã‡Ä±kÄ±ÅŸ Yap</button>
        </div>
    </div>
</div>

<div id="statusBar" class="status-bar"></div>

<script>
    // ============================================================
    // 1. AYARLAR: FIREBASE BÄ°LGÄ°LERÄ°
    // ============================================================
    const firebaseConfig = {
        apiKey:  "AIzaSyApl74nGCJrG42BWFJaR_v3gqHGlF2R_3M",
        authDomain: "otomotiv-masa-tenisi-turnuvasi.firebaseapp.com",
        databaseURL: "https://otomotiv-masa-tenisi-turnuvasi-default-rtdb.firebaseio.com",
        projectId: "otomotiv-masa-tenisi-turnuvasi",
        storageBucket: "otomotiv-masa-tenisi-turnuvasi.firebasestorage.app",
        messagingSenderId: "88398060894",
        appId: "1:88398060894:web:8b9e4e1198466aae1283cf",
        measurementId: "G-GC6ND6CK6J"
    };

    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const db = firebase.database();
    const auth = firebase.auth();

    // ============================================================
    // 2. STATE YÃ–NETÄ°MÄ°
    // ============================================================
    let appData = { players: [], matches: [], started: false };
    let isAdmin = false;

    window.onload = function() {
        auth.onAuthStateChanged(user => {
            isAdmin = !!user;
            document.getElementById('loginPanel').style.display = isAdmin ? 'none' : 'block';
            document.getElementById('adminControls').style.display = isAdmin ? 'block' : 'none';
            document.getElementById('saveBtnArea').style.display = isAdmin ? 'block' : 'none';
            if(isAdmin) showStatus("YÃ¶netici modundasÄ±nÄ±z.", "success");
            renderFixture(); // Yetki deÄŸiÅŸince tekrar render et
        });

        db.ref('turnuva').on('value', (snapshot) => {
            const data = snapshot.val();
            document.getElementById('loading').style.display = 'none';
            
            if (data) {
                appData = data;
                if(!appData.players) appData.players = [];
                if(!appData.matches) appData.matches = [];
                
                calculateStandings();
                renderFixture();
                renderVoting();
                
                if(document.querySelector('.tab-content.active') === null) {
                    openTab('puanDurumu');
                }
            } else {
                openTab('puanDurumu');
            }
        });
    };

    // ============================================================
    // 3. Ä°ÅLEVLER (LOGIC)
    // ============================================================
    function isValidScore(val) {
        return val !== null && val !== "" && !isNaN(val);
    }

    function calculateStandings() {
        appData.players.forEach(p => p.stats = { p:0, o:0, g:0, m:0, a:0, y:0, av:0 });

        appData.matches.forEach(m => {
            if (isValidScore(m.s1) && isValidScore(m.s2)) {
                const p1 = appData.players.find(pl => pl.name === m.p1);
                const p2 = appData.players.find(pl => pl.name === m.p2);

                if (p1 && p2) {
                    const s1 = parseInt(m.s1);
                    const s2 = parseInt(m.s2);

                    p1.stats.o++; p2.stats.o++;
                    p1.stats.a += s1; p1.stats.y += s2;
                    p2.stats.a += s2; p2.stats.y += s1;

                    if (s1 > s2) {
                        p1.stats.g++; p1.stats.p += 2;
                        p2.stats.m++; p2.stats.p += m.hukmen ? 0 : 1;
                    } else if (s2 > s1) {
                        p2.stats.g++; p2.stats.p += 2;
                        p1.stats.m++; p1.stats.p += m.hukmen ? 0 : 1;
                    }
                }
            }
        });

        // Ã‡EKÄ°LME KONTROLÃœ (HÃœKMEN)
        appData.players.forEach(p => {
            if(p.withdrawn) {
                // Ã‡ekilen oyuncuyu sÄ±fÄ±rla
                p.stats = { p:0, o:0, g:0, m:0, a:0, y:0, av:0 };
            } else {
                p.stats.av = (p.stats.a || 0) - (p.stats.y || 0);
            }
        });

        // Standart SÄ±ralama: 1. Puan, 2. Averaj, 3. Ä°sim (A-Z)
        appData.players.sort((a, b) => {
            if (b.stats.p !== a.stats.p) return b.stats.p - a.stats.p;
            if (b.stats.av !== a.stats.av) return b.stats.av - a.stats.av;
            return a.name.localeCompare(b.name);
        });

        renderStandings();
    }

    // --- OYUNCU Ã‡EKÄ°LME (HÃœKMEN) ---
    window.togglePlayerWithdrawal = function(playerName, event) {
        event.stopPropagation(); // Accordion aÃ§Ä±lmasÄ±nÄ± engelle
        if(!isAdmin) return;

        const player = appData.players.find(p => p.name === playerName);
        if(player) {
            // Durumu tersine Ã§evir (Ã‡ekildi <-> Aktif)
            player.withdrawn = !player.withdrawn;
            
            // Hesapla ve ArayÃ¼zÃ¼ GÃ¼ncelle
            calculateStandings();
            renderFixture(); // Butonun durumunu gÃ¼ncellemek iÃ§in
            renderStandings(); // Tabloyu gÃ¼ncellemek iÃ§in
            
            showStatus(player.withdrawn ? `${playerName} turnuvadan Ã§ekildi.` : `${playerName} tekrar aktif edildi.`, "success");
        }
    }

    // --- OY KULLANMA ---
    window.castVote = function(matchIdx, playerKey) {
        const storageKey = 'voted_match_' + matchIdx;
        if (localStorage.getItem(storageKey)) {
            showStatus("Bu maÃ§ iÃ§in zaten oy kullandÄ±nÄ±z!", "error");
            return;
        }

        const matchRef = db.ref('turnuva/matches/' + matchIdx);
        
        matchRef.transaction((match) => {
            if (match) {
                if (playerKey === 1) {
                    match.v1 = (match.v1 || 0) + 1;
                } else {
                    match.v2 = (match.v2 || 0) + 1;
                }
            }
            return match;
        }, (error, committed) => {
            if (error) {
                if (error.code === 'PERMISSION_DENIED') {
                    showStatus("HATA: Ä°zin Yok!", "error");
                } else {
                    showStatus("Oy verilemedi: " + error.message, "error");
                }
            } else if (committed) {
                localStorage.setItem(storageKey, "true");
                showStatus("Oyunuz kaydedildi!", "success");
                renderVoting(); 
            }
        });
    }

    // --- YÃ–NETÄ°CÄ° ---
    function importFromPythonJson() {
        const fileInput = document.getElementById('jsonFileInput');
        const file = fileInput.files[0];
        if (!file) return alert("LÃ¼tfen bir dosya seÃ§in.");

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const pyData = JSON.parse(e.target.result);
                if (!pyData.oyuncular || !pyData.maclar) return alert("GeÃ§ersiz dosya formatÄ±.");
                if(!confirm("Mevcut veriler silinecek. OnaylÄ±yor musunuz?")) return;

                const newPlayers = pyData.oyuncular.map(name => ({
                    name: name,
                    withdrawn: false,
                    stats: { p:0, o:0, g:0, m:0, a:0, y:0, av:0 }
                }));

                const newMatches = pyData.maclar.map(m => ({
                    round: m.gun,
                    p1: m.p1, p2: m.p2,
                    s1: isValidScore(m.s1) ? parseInt(m.s1) : null,
                    s2: isValidScore(m.s2) ? parseInt(m.s2) : null,
                    hukmen: m.hukmen || false,
                    v1: 0, v2: 0
                }));

                appData = { players: newPlayers, matches: newMatches, started: true };
                calculateStandings();

                db.ref('turnuva').set(appData)
                    .then(() => { alert("Veriler yÃ¼klendi!"); openTab('puanDurumu'); })
                    .catch(err => alert("Hata: " + err.message));

            } catch (error) { alert("Dosya okuma hatasÄ±."); }
        };
        reader.readAsText(file);
    }

    function downloadJsonData() {
        if(!appData) return alert("Ä°ndirilecek veri yok.");
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "turnuva_verisi_" + new Date().toISOString().slice(0,10) + ".json");
        document.body.appendChild(downloadAnchorNode); // required for firefox
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    function login() {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('password').value;
        auth.signInWithEmailAndPassword(email, pass).catch(e => alert(e.message));
    }

    window.updateScore = function(index, field, value) {
        if(!isAdmin) return;
        appData.matches[index][field] = value === '' ? null : parseInt(value);
    }

    window.toggleHukmen = function(index) {
        if(!isAdmin) return;
        appData.matches[index].hukmen = !appData.matches[index].hukmen;
        renderFixture(); 
    }

    window.saveDataToFirebase = function() {
        if(!isAdmin) return;
        calculateStandings(); 
        db.ref('turnuva').update(appData)
            .then(() => showStatus("DeÄŸiÅŸiklikler yayÄ±nlandÄ±!", "success"))
            .catch(err => alert(err.message));
    }

    // ============================================================
    // 4. ARAYÃœZ (RENDER) - GÃœNCELLENDÄ°
    // ============================================================
    function renderStandings() {
        const standardBody = document.getElementById('standingsBody');
        const weightedBody = document.getElementById('weightedStandingsBody');
        
        standardBody.innerHTML = '';
        weightedBody.innerHTML = '';

        // --- 1. TABLO (STANDART) ---
        appData.players.forEach((p, index) => {
            const rowClass = p.withdrawn ? 'withdrawn-row' : (index < 8 ? 'top8' : '');
            
            standardBody.innerHTML += `
                <tr class="${rowClass}">
                    <td>${index + 1}</td>
                    <td style="text-align:left; padding-left:15px; font-weight:600;">${p.name} ${p.withdrawn ? '(Ã‡EKÄ°LDÄ°)' : ''}</td>
                    <td>${p.stats.o}</td>
                    <td>${p.stats.g}</td>
                    <td>${p.stats.m}</td>
                    <td>${p.stats.av}</td>
                    <td><strong>${p.stats.p}</strong></td>
                </tr>`;
        });

        // --- 2. TABLO (AÄIRLIKLI ORTALAMA) ---
        const weightedPlayers = [...appData.players].sort((a, b) => {
            const avgA = a.stats.o > 0 ? a.stats.p / a.stats.o : 0;
            const avgB = b.stats.o > 0 ? b.stats.p / b.stats.o : 0;
            
            if (avgB !== avgA) return avgB - avgA;
            return b.stats.p - a.stats.p;
        });

        weightedPlayers.forEach((p, index) => {
            const avg = p.stats.o > 0 ? (p.stats.p / p.stats.o).toFixed(2) : "0.00";
            const rowClass = p.withdrawn ? 'withdrawn-row' : '';
            
            weightedBody.innerHTML += `
                <tr class="${rowClass}">
                    <td>${index + 1}</td>
                    <td style="text-align:left; padding-left:15px; font-weight:600;">${p.name} ${p.withdrawn ? '(Ã‡EKÄ°LDÄ°)' : ''}</td>
                    <td>${p.stats.o}</td>
                    <td>${p.stats.p}</td>
                    <td style="font-weight:bold; color:var(--accent); background:${p.withdrawn ? '#333' : '#f0f9f4'};">${avg}</td>
                </tr>`;
        });
    }

    // Puan Durumu Sekme GeÃ§iÅŸi
    window.switchStandingsView = function(view) {
        document.getElementById('standingsStandard').style.display = view === 'standard' ? 'block' : 'none';
        document.getElementById('standingsWeighted').style.display = view === 'weighted' ? 'block' : 'none';
        
        document.getElementById('btnStandingsStandard').classList.toggle('active', view === 'standard');
        document.getElementById('btnStandingsWeighted').classList.toggle('active', view === 'weighted');
    }

    // YARDIMCI FONKSÄ°YON: MaÃ§ KartÄ± HTML'i OluÅŸturur
    function createMatchCardHTML(m, forceLeftPlayer = null) {
        const disabled = isAdmin ? '' : 'disabled';
        
        let isSwapped = false;
        if (forceLeftPlayer && m.p2 === forceLeftPlayer) {
            isSwapped = true;
        }

        const pLeftName = isSwapped ? m.p2 : m.p1;
        const pRightName = isSwapped ? m.p1 : m.p2;
        
        const sLeftVal = isSwapped ? m.s2 : m.s1;
        const sRightVal = isSwapped ? m.s1 : m.s2;

        const fieldLeft = isSwapped ? 's2' : 's1';   
        const fieldRight = isSwapped ? 's1' : 's2';
        
        const vLeft = isSwapped ? (m.v2 || 0) : (m.v1 || 0);
        const vRight = isSwapped ? (m.v1 || 0) : (m.v2 || 0);

        let pLeftStyle = '';
        let pRightStyle = '';
        if (sLeftVal !== null && sLeftVal !== "" && sRightVal !== null && sRightVal !== "") {
            const valL = parseInt(sLeftVal);
            const valR = parseInt(sRightVal);
            if (valL > valR) { pLeftStyle = 'color:var(--accent);'; pRightStyle = 'color:var(--danger);'; } 
            else if (valR > valL) { pLeftStyle = 'color:var(--danger);'; pRightStyle = 'color:var(--accent);'; }
        }
        
        const total = vLeft + vRight;
        const pctLeft = total > 0 ? Math.round((vLeft / total) * 100) : 0;
        const pctRight = total > 0 ? Math.round((vRight / total) * 100) : 0;

        const pLeftDisplay = `%${pctLeft} <span style="font-size:9px; display:block; color:#7f8c8d; font-weight:normal;">(${vLeft}/${total})</span>`;
        const pRightDisplay = `%${pctRight} <span style="font-size:9px; display:block; color:#7f8c8d; font-weight:normal;">(${vRight}/${total})</span>`;

        let hukmenHtml = isAdmin ? `<div class="hukmen-toggle ${m.hukmen ? 'active' : ''}" onclick="toggleHukmen(${m.idx})">H</div>` : '';
        let hukmenLabel = (!isAdmin && m.hukmen) ? '<span class="hukmen-indicator">(HÃœKMEN)</span>' : '';

        return `
            <div class="match-card">
                <div class="player-container left">
                    <div class="vote-ratio" title="Oy DaÄŸÄ±lÄ±mÄ±">${pLeftDisplay}</div>
                    <div class="player p1" style="${pLeftStyle}; margin-left:8px;">${pLeftName}</div>
                </div>
                
                <div class="scores">
                    <input type="number" ${disabled} value="${sLeftVal !== null ? sLeftVal : ''}" oninput="updateScore(${m.idx}, '${fieldLeft}', this.value)">
                    <span style="color:#ccc;">-</span>
                    <input type="number" ${disabled} value="${sRightVal !== null ? sRightVal : ''}" oninput="updateScore(${m.idx}, '${fieldRight}', this.value)">
                    ${hukmenHtml}
                    ${hukmenLabel}
                </div>

                <div class="player-container right">
                    <div class="player p2" style="${pRightStyle}; margin-right:8px;">${pRightName}</div>
                    <div class="vote-ratio" title="Oy DaÄŸÄ±lÄ±mÄ±">${pRightDisplay}</div>
                </div>
            </div>
        `;
    }

    function renderFixture() {
        if(document.activeElement.tagName === "INPUT") return;
        
        const matchesWithIdx = appData.matches.map((m, index) => ({...m, idx: index}));

        // --- 1. GÃœN GÃ–RÃœNÃœMÃœ ---
        const dayContainer = document.getElementById('fixtureByDay');
        dayContainer.innerHTML = '';
        if (!matchesWithIdx.length) {
            dayContainer.innerHTML = '<p style="text-align:center; color:#999;">MaÃ§ yok.</p>';
        } else {
            const rounds = {};
            matchesWithIdx.forEach(m => {
                if (!rounds[m.round]) rounds[m.round] = [];
                rounds[m.round].push(m);
            });

            for (const [round, matches] of Object.entries(rounds)) {
                const header = document.createElement('div');
                header.className = 'day-header';
                header.innerText = `${round}. GÃœN`;
                dayContainer.appendChild(header);

                matches.forEach(m => {
                    dayContainer.innerHTML += createMatchCardHTML(m);
                });
            }
        }

        // --- 2. OYUNCU GÃ–RÃœNÃœMÃœ (ACCORDION/TOGGLE) ---
        const playerContainer = document.getElementById('fixtureByPlayer');
        playerContainer.innerHTML = '';
        
        const sortedPlayers = [...appData.players].sort((a, b) => a.name.localeCompare(b.name));
        
        sortedPlayers.forEach((p, index) => {
            const playerMatches = matchesWithIdx.filter(m => m.p1 === p.name || m.p2 === p.name);
            
            if (playerMatches.length > 0) {
                const uniqueId = `matches-${index}`;
                
                // HÃ¼kmen Butonu (Sadece Admin GÃ¶rÃ¼r)
                let withdrawBtn = '';
                if(isAdmin) {
                    const btnClass = p.withdrawn ? 'withdraw-btn active' : 'withdraw-btn';
                    const btnText = p.withdrawn ? 'GERÄ° AL' : 'HÃœKMEN';
                    withdrawBtn = `<button class="${btnClass}" onclick="togglePlayerWithdrawal('${p.name}', event)">${btnText}</button>`;
                }

                // Toggle BaÅŸlÄ±ÄŸÄ±
                playerContainer.innerHTML += `
                    <div class="player-header" onclick="togglePlayerAccordion('${uniqueId}', this)">
                        <div style="display:flex; align-items:center;">
                            <span>${p.name}</span>
                            <span style="font-size:10px; opacity:0.6; font-weight:normal; margin-left:8px;">${p.withdrawn ? '(Ã‡EKÄ°LDÄ°)' : ''}</span>
                        </div>
                        <div style="display:flex; align-items:center; gap:5px;">
                            ${withdrawBtn}
                            <span style="font-size:11px; opacity:0.8; font-weight:normal;">${playerMatches.length} MaÃ§</span>
                            <span class="arrow">â–¼</span>
                        </div>
                    </div>
                `;
                
                // Gizli Ä°Ã§erik Kutusu
                let matchesHtml = `<div id="${uniqueId}" class="player-matches-container">`;
                
                playerMatches.sort((a, b) => a.round - b.round);
                playerMatches.forEach(m => {
                    const dayLabel = `<div style="text-align:center; font-size:10px; color:#999; margin-bottom:2px; font-weight:bold;">${m.round}. GÃœN</div>`;
                    const cardHtml = createMatchCardHTML(m, p.name);
                    matchesHtml += `<div style="margin-top:-5px;">${dayLabel}${cardHtml}</div>`;
                });
                
                matchesHtml += `</div>`;
                playerContainer.innerHTML += matchesHtml;
            }
        });
    }

    // Accordion Toggle Fonksiyonu
    window.togglePlayerAccordion = function(elementId, headerElement) {
        const content = document.getElementById(elementId);
        const isVisible = content.style.display === 'block';
        
        // AÃ§ / Kapa
        content.style.display = isVisible ? 'none' : 'block';
        headerElement.classList.toggle('active', !isVisible);
    }

    // FikstÃ¼r Sekme GeÃ§iÅŸi
    window.switchFixtureView = function(view) {
        document.getElementById('fixtureByDay').style.display = view === 'day' ? 'block' : 'none';
        document.getElementById('fixtureByPlayer').style.display = view === 'player' ? 'block' : 'none';
        
        document.getElementById('btnDayView').classList.toggle('active', view === 'day');
        document.getElementById('btnPlayerView').classList.toggle('active', view === 'player');
    }

    function renderVoting() {
        const container = document.getElementById('votingList');
        container.innerHTML = '';
        
        const rounds = {};
        appData.matches.forEach((m, index) => {
            if (!rounds[m.round]) rounds[m.round] = [];
            rounds[m.round].push({ ...m, idx: index });
        });

        for (const [round, matches] of Object.entries(rounds)) {
            const header = document.createElement('div');
            header.className = 'day-header';
            header.innerText = `${round}. GÃœN`;
            container.appendChild(header);

            matches.forEach(m => {
                const card = document.createElement('div');
                card.className = 'match-card';
                
                const hasVoted = localStorage.getItem('voted_match_' + m.idx);
                const disabledClass = hasVoted ? 'voted' : '';
                
                card.innerHTML = `
                    <div style="width:45%; display:flex; justify-content:flex-end; align-items:center; gap:10px;">
                        <span style="font-size:13px; font-weight:600;">${m.p1}</span>
                        <button class="vote-btn ${disabledClass}" onclick="castVote(${m.idx}, 1)">ğŸ‘</button>
                    </div>
                    
                    <div style="width:10%; text-align:center; color:#ccc; font-weight:bold;">VS</div>

                    <div style="width:45%; display:flex; justify-content:flex-start; align-items:center; gap:10px;">
                        <button class="vote-btn ${disabledClass}" onclick="castVote(${m.idx}, 2)">ğŸ‘</button>
                        <span style="font-size:13px; font-weight:600;">${m.p2}</span>
                    </div>
                `;
                container.appendChild(card);
            });
        }
    }

    window.openTab = function(tabName) {
        document.querySelectorAll('.tab-content').forEach(t => { t.style.display = 'none'; t.classList.remove('active'); });
        document.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
        
        const selected = document.getElementById(tabName);
        selected.style.display = 'block';
        setTimeout(() => selected.classList.add('active'), 10);
        
        const btns = document.querySelectorAll('.navbar button');
        if(tabName === 'puanDurumu') btns[0].classList.add('active');
        if(tabName === 'fikstur') btns[1].classList.add('active');
        if(tabName === 'oylama') btns[2].classList.add('active');
        if(tabName === 'kurallar') btns[3].classList.add('active');
        if(tabName === 'admin') btns[4].classList.add('active');
    }

    function showStatus(msg, type) {
        const bar = document.getElementById('statusBar');
        bar.innerText = msg;
        bar.style.background = type === 'success' ? '#27ae60' : (type === 'error' ? '#e74c3c' : '#333');
        bar.style.display = 'block';
        setTimeout(() => { bar.style.display = 'none'; }, 3000);
    }
</script>

</body>
</html>
