<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CanlÄ± Masa Tenisi TurnuvasÄ±</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --light: #ecf0f1; --danger: #e74c3c; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background: #f0f2f5; color: #333; padding-bottom: 60px; }
        
        /* Navbar */
        .navbar { background: var(--primary); display: flex; justify-content: space-around; padding: 0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .navbar button { flex: 1; padding: 15px; background: transparent; border: none; color: #bdc3c7; font-size: 14px; font-weight: bold; cursor: pointer; transition: 0.3s; border-bottom: 4px solid transparent; }
        .navbar button.active { color: white; border-bottom: 4px solid var(--accent); background: rgba(255,255,255,0.05); }

        /* Container */
        .container { max-width: 800px; margin: 0 auto; padding: 15px; }
        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }

        /* Tablo */
        .table-container { overflow-x: auto; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); background: white; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 350px; }
        th, td { padding: 12px 8px; text-align: center; border-bottom: 1px solid #eee; font-size: 14px; }
        th { background: var(--primary); color: white; font-weight: 600; font-size: 12px; letter-spacing: 0.5px; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .top8 { background-color: #e8f5e9 !important; } 
        .top8 td:first-child { border-left: 4px solid var(--accent); font-weight: bold; color: var(--accent); }

        /* FikstÃ¼r KartlarÄ± */
        .day-header { text-align: center; margin: 25px 0 10px; font-weight: 800; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; font-size: 13px; position: relative; }
        .day-header::after { content: ''; display: block; width: 40px; height: 3px; background: var(--accent); margin: 5px auto 0; border-radius: 2px; }
        
        .match-card { background: white; padding: 12px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; }
        .player { width: 30%; font-weight: 600; font-size: 14px; word-wrap: break-word; line-height: 1.2; }
        .player.p1 { text-align: right; }
        .player.p2 { text-align: left; }
        
        /* Skor AlanÄ± */
        .scores { display: flex; align-items: center; gap: 5px; justify-content: center; width: 40%; }
        .scores input { width: 32px; height: 32px; text-align: center; font-size: 16px; border: 1px solid #ddd; border-radius: 4px; font-weight: bold; background: #f9f9f9; }
        .scores input:focus { outline: none; border-color: var(--accent); background: white; }
        .scores input:disabled { background: #eee; color: #333; border: none; }

        /* HÃ¼kmen Butonu */
        .hukmen-toggle { 
            width: 24px; 
            height: 24px; 
            border-radius: 4px; 
            border: 1px solid #ccc; 
            color: #777; 
            font-size: 10px; 
            font-weight: bold;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            margin-left: 8px;
            user-select: none;
            background: #fff;
            transition: all 0.2s;
        }
        .hukmen-toggle:hover { background: #f0f0f0; }
        .hukmen-toggle.active { background: var(--danger); color: white; border-color: var(--danger); }
        .hukmen-indicator { font-size: 10px; color: var(--danger); font-weight: bold; margin-left: 5px; }

        /* Admin Panel */
        .admin-box { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; }
        .admin-box input[type="text"], .admin-box input[type="email"], .admin-box input[type="password"] { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 5px; text-transform: uppercase; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: #219150; }
        .btn-danger { background: var(--danger); color: white; margin-top: 20px; }
        .btn-secondary { background: #34495e; color: white; }
        .file-upload { background: #f1f1f1; padding: 15px; border-radius: 6px; margin-top: 15px; border: 2px dashed #ccc; }

        .status-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #333; color: white; padding: 12px; text-align: center; font-size: 13px; z-index: 2000; display: none; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 600px) { .player { font-size: 12px; } .scores input { width: 28px; height: 28px; font-size: 14px; } }
    </style>
</head>
<body>

<div class="navbar">
    <button class="tab-link active" onclick="openTab('puanDurumu')">PUAN DURUMU</button>
    <button class="tab-link" onclick="openTab('fikstur')">FÄ°KSTÃœR</button>
    <button class="tab-link" onclick="openTab('admin')">YÃ–NETÄ°CÄ°</button>
</div>

<div class="container">
    <div id="loading" class="loader"></div>

    <div id="puanDurumu" class="tab-content" style="display:none;">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th width="10%">#</th>
                        <th width="40%" style="text-align:left; padding-left:15px;">OYUNCU</th>
                        <th width="10%">O</th>
                        <th width="10%">G</th>
                        <th width="10%">M</th>
                        <th width="10%">AV</th>
                        <th width="10%">P</th>
                    </tr>
                </thead>
                <tbody id="standingsBody"></tbody>
            </table>
        </div>
        <p style="text-align:center; color:#7f8c8d; font-size:11px; margin-top:5px;">Ä°lk 8 Play-off oynar. | G:2 Puan, M:1 Puan, HÃ¼kmen: 0 Puan</p>
    </div>

    <div id="fikstur" class="tab-content" style="display:none;">
        <div id="fixtureList"></div>
        <div id="saveBtnArea" style="margin-top:20px; display:none; position:sticky; bottom:20px;">
            <button class="btn btn-primary" style="box-shadow: 0 4px 10px rgba(0,0,0,0.3);" onclick="saveDataToFirebase()">ðŸ’¾ SKORLARI KAYDET VE YAYINLA</button>
        </div>
    </div>

    <div id="admin" class="tab-content" style="display:none;">
        <div id="loginPanel" class="admin-box">
            <h2 style="color:var(--primary);">YÃ¶netici GiriÅŸi</h2>
            <input type="email" id="email" placeholder="E-Posta">
            <input type="password" id="password" placeholder="Åžifre">
            <button class="btn btn-primary" onclick="login()">GiriÅŸ Yap</button>
        </div>

        <div id="adminControls" class="admin-box" style="display:none;">
            <h3 style="color:var(--accent); margin-top:0;">YÃ¶netim Paneli</h3>
            
            <div class="file-upload">
                <h4 style="margin:0 0 10px 0; color:#555;">Python Verisini YÃ¼kle</h4>
                <p style="font-size:11px; color:#777; margin-bottom:10px;">Python uygulamasÄ±ndan kaydettiÄŸin .json dosyasÄ±nÄ± seÃ§.</p>
                <input type="file" id="jsonFileInput" accept=".json" style="width:100%; margin-bottom:10px;">
                <button class="btn btn-secondary" onclick="importFromPythonJson()">ðŸ“‚ YÃœKLE VE YAYINLA</button>
            </div>

            <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">

            <h4 style="margin:0 0 10px 0; color:#555;">veya Yeni Lig OluÅŸtur</h4>
            <input type="text" id="newPlayerName" placeholder="Yeni Oyuncu Ä°smi">
            <button class="btn btn-secondary" style="background:#95a5a6;" onclick="addPlayerTemp()">Listeye Ekle</button>
            <ul id="tempPlayerList" style="text-align:left; color:#555; font-size:13px; padding-left:20px;"></ul>

            <button class="btn btn-primary" style="margin-top:10px;" onclick="generateFixtureAndStart()">ðŸš€ MANUEL LÄ°GÄ° BAÅžLAT</button>
            <button class="btn btn-danger" onclick="firebase.auth().signOut()">Ã‡Ä±kÄ±ÅŸ Yap</button>
        </div>
    </div>
</div>

<div id="statusBar" class="status-bar"></div>

<script>
    // ============================================================
    // 1. AYARLAR: FIREBASE BÄ°LGÄ°LERÄ°NÄ° BURAYA GÄ°RÄ°NÄ°Z
    // ============================================================
    const firebaseConfig = {
        apiKey:  "AIzaSyApl74nGCJrG42BWFJaR_v3gqHGlF2R_3M",
        authDomain: "otomotiv-masa-tenisi-turnuvasi.firebaseapp.com",
        databaseURL: "https://otomotiv-masa-tenisi-turnuvasi-default-rtdb.firebaseio.com",
        projectId: "otomotiv-masa-tenisi-turnuvasi",
        storageBucket: "otomotiv-masa-tenisi-turnuvasi.firebasestorage.app",
        messagingSenderId: "88398060894",
        appId: "1:88398060894:web:8b9e4e1198466aae1283cf",
	measurementId: "G-GC6ND6CK6J"
    };

    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const db = firebase.database();
    const auth = firebase.auth();

    // ============================================================
    // 2. STATE YÃ–NETÄ°MÄ°
    // ============================================================
    let appData = { players: [], matches: [], started: false };
    let tempPlayers = [];
    let isAdmin = false;

    window.onload = function() {
        auth.onAuthStateChanged(user => {
            isAdmin = !!user;
            document.getElementById('loginPanel').style.display = isAdmin ? 'none' : 'block';
            document.getElementById('adminControls').style.display = isAdmin ? 'block' : 'none';
            document.getElementById('saveBtnArea').style.display = isAdmin ? 'block' : 'none';
            if(isAdmin) showStatus("YÃ¶netici modundasÄ±nÄ±z.", "success");
            renderFixture();
        });

        db.ref('turnuva').on('value', (snapshot) => {
            const data = snapshot.val();
            document.getElementById('loading').style.display = 'none';
            
            if (data) {
                appData = data;
                if(!appData.players) appData.players = [];
                if(!appData.matches) appData.matches = [];
                
                calculateStandings();
                renderFixture();
                
                if(document.getElementById('puanDurumu').style.display === 'none' && 
                   document.getElementById('fikstur').style.display === 'none' && 
                   document.getElementById('admin').style.display === 'none') {
                    openTab('puanDurumu');
                }
            } else {
                openTab('puanDurumu');
                document.getElementById('fixtureList').innerHTML = '<p style="text-align:center; padding:20px; color:#999;">Turnuva verisi bulunamadÄ±.</p>';
            }
        });
    };

    // ============================================================
    // 3. Ä°ÅžLEVLER (LOGIC)
    // ============================================================
    
    // Skorun geÃ§erli olup olmadÄ±ÄŸÄ±nÄ± kontrol eden yardÄ±mcÄ± fonksiyon
    function isValidScore(val) {
        return val !== null && val !== "" && !isNaN(val);
    }

    // Puan Durumu Hesaplama (DÃœZELTÄ°LDÄ°: Oynanan MaÃ§ ve Averaj)
    function calculateStandings() {
        // 1. Ä°statistikleri tamamen sÄ±fÄ±rla
        appData.players.forEach(p => p.stats = { p:0, o:0, g:0, m:0, a:0, y:0, av:0 });

        // 2. MaÃ§larÄ± gez
        appData.matches.forEach(m => {
            // DÃœZELTME: Sadece iki skor da geÃ§erliyse (doluysa) iÅŸlem yap
            if (isValidScore(m.s1) && isValidScore(m.s2)) {
                const p1 = appData.players.find(pl => pl.name === m.p1);
                const p2 = appData.players.find(pl => pl.name === m.p2);

                if (p1 && p2) {
                    const s1 = parseInt(m.s1);
                    const s2 = parseInt(m.s2);

                    // Oynanan maÃ§Ä± artÄ±r
                    p1.stats.o++; 
                    p2.stats.o++;
                    
                    // AtÄ±lan/Yenilen sayÄ±larÄ± topla
                    p1.stats.a += s1; 
                    p1.stats.y += s2;
                    p2.stats.a += s2; 
                    p2.stats.y += s1;

                    // Puanlama (Galip:2, MaÄŸlup:1, HÃ¼kmen MaÄŸlup:0)
                    if (s1 > s2) {
                        p1.stats.g++; p1.stats.p += 2;
                        p2.stats.m++; p2.stats.p += m.hukmen ? 0 : 1;
                    } else if (s2 > s1) {
                        p2.stats.g++; p2.stats.p += 2;
                        p1.stats.m++; p1.stats.p += m.hukmen ? 0 : 1;
                    }
                }
            }
        });

        // 3. AverajÄ± hesapla (DÃœZELTME: NaN olmamasÄ± iÃ§in kontrol)
        appData.players.forEach(p => {
            p.stats.av = (p.stats.a || 0) - (p.stats.y || 0);
        });

        // 4. SÄ±ralama
        appData.players.sort((a, b) => {
            if (b.stats.p !== a.stats.p) return b.stats.p - a.stats.p;
            if (b.stats.av !== a.stats.av) return b.stats.av - a.stats.av;
            return b.stats.a - a.stats.a;
        });

        renderStandings();
    }

    function importFromPythonJson() {
        const fileInput = document.getElementById('jsonFileInput');
        const file = fileInput.files[0];
        if (!file) return alert("LÃ¼tfen bir dosya seÃ§in.");

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const pyData = JSON.parse(e.target.result);
                if (!pyData.oyuncular || !pyData.maclar) return alert("GeÃ§ersiz dosya formatÄ±.");
                if(!confirm("Mevcut veriler silinecek. OnaylÄ±yor musunuz?")) return;

                // OyuncularÄ± temiz bir istatistikle oluÅŸtur
                const newPlayers = pyData.oyuncular.map(name => ({
                    name: name,
                    stats: { p:0, o:0, g:0, m:0, a:0, y:0, av:0 }
                }));

                // MaÃ§larÄ± gÃ¼venli tipe Ã§evir
                const newMatches = pyData.maclar.map(m => ({
                    round: m.gun,
                    p1: m.p1,
                    p2: m.p2,
                    // BoÅŸ stringleri null yap, sayÄ±larÄ± int yap
                    s1: isValidScore(m.s1) ? parseInt(m.s1) : null,
                    s2: isValidScore(m.s2) ? parseInt(m.s2) : null,
                    hukmen: m.hukmen || false
                }));

                appData = { players: newPlayers, matches: newMatches, started: true };
                
                // Hemen hesapla ki Firebase'e doÄŸru gitsin
                calculateStandings();

                db.ref('turnuva').set(appData)
                    .then(() => { alert("Veriler baÅŸarÄ±yla yÃ¼klendi!"); openTab('puanDurumu'); })
                    .catch(err => alert("Hata: " + err.message));

            } catch (error) { alert("Dosya okuma hatasÄ±."); }
        };
        reader.readAsText(file);
    }

    // --- Standart Fonksiyonlar ---
    function login() {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('password').value;
        auth.signInWithEmailAndPassword(email, pass).catch(e => alert(e.message));
    }

    function addPlayerTemp() {
        const name = document.getElementById('newPlayerName').value.trim();
        if(name) {
            tempPlayers.push({ name: name, stats: {} });
            document.getElementById('newPlayerName').value = '';
            document.getElementById('tempPlayerList').innerHTML = tempPlayers.map(p => `<li>${p.name}</li>`).join('');
        }
    }

    function generateFixtureAndStart() {
        if(tempPlayers.length < 2) return alert("En az 2 oyuncu gerekli.");
        if(!confirm("Eski veriler silinecek.")) return;

        let players = [...tempPlayers];
        if (players.length % 2 !== 0) players.push(null);

        const numRounds = players.length - 1;
        const matchesPerRound = players.length / 2;
        let matches = [];

        for (let r = 0; r < numRounds; r++) {
            for (let i = 0; i < matchesPerRound; i++) {
                const p1 = players[i];
                const p2 = players[players.length - 1 - i];
                if (p1 && p2) {
                    matches.push({ round: r + 1, p1: p1.name, p2: p2.name, s1: null, s2: null, hukmen: false });
                }
            }
            players.splice(1, 0, players.pop());
        }

        const newData = { players: tempPlayers, matches: matches, started: true };
        db.ref('turnuva').set(newData).then(() => { tempPlayers = []; openTab('fikstur'); });
    }

    window.updateScore = function(index, field, value) {
        if(!isAdmin) return;
        appData.matches[index][field] = value === '' ? null : parseInt(value);
    }

    window.toggleHukmen = function(index) {
        if(!isAdmin) return;
        appData.matches[index].hukmen = !appData.matches[index].hukmen;
        renderFixture();
    }

    window.saveDataToFirebase = function() {
        if(!isAdmin) return;
        calculateStandings(); // Kaydetmeden Ã¶nce hesapla
        db.ref('turnuva').update(appData)
            .then(() => showStatus("DeÄŸiÅŸiklikler yayÄ±nlandÄ±!", "success"))
            .catch(err => alert(err.message));
    }

    // ============================================================
    // 4. ARAYÃœZ (RENDER)
    // ============================================================
    function renderStandings() {
        const tbody = document.getElementById('standingsBody');
        tbody.innerHTML = '';
        appData.players.forEach((p, index) => {
            tbody.innerHTML += `
                <tr class="${index < 8 ? 'top8' : ''}">
                    <td>${index + 1}</td>
                    <td style="text-align:left; padding-left:15px; font-weight:600;">${p.name}</td>
                    <td>${p.stats.o}</td>
                    <td>${p.stats.g}</td>
                    <td>${p.stats.m}</td>
                    <td>${p.stats.av}</td>
                    <td><strong>${p.stats.p}</strong></td>
                </tr>`;
        });
    }

    function renderFixture() {
        const container = document.getElementById('fixtureList');
        if(document.activeElement.tagName === "INPUT") return;
        container.innerHTML = '';
        if (!appData.matches.length) return container.innerHTML = '<p style="text-align:center; color:#999;">MaÃ§ yok.</p>';

        const rounds = {};
        appData.matches.forEach((m, index) => {
            if (!rounds[m.round]) rounds[m.round] = [];
            rounds[m.round].push({ ...m, idx: index });
        });

        for (const [round, matches] of Object.entries(rounds)) {
            const header = document.createElement('div');
            header.className = 'day-header';
            header.innerText = `${round}. GÃœN`;
            container.appendChild(header);

            matches.forEach(m => {
                const card = document.createElement('div');
                card.className = 'match-card';
                const disabled = isAdmin ? '' : 'disabled';
                
                // HÃ¼kmen Butonu HTML (Flex yapÄ±sÄ±na uygun)
                let hukmenHtml = '';
                let hukmenLabel = '';
                if(isAdmin) {
                    const activeClass = m.hukmen ? 'active' : '';
                    hukmenHtml = `<div class="hukmen-toggle ${activeClass}" onclick="toggleHukmen(${m.idx})">H</div>`;
                }
                if(m.hukmen && !isAdmin) {
                     hukmenLabel = '<span class="hukmen-indicator" style="position:static; margin-left:5px;">(HÃœKMEN)</span>';
                }

                card.innerHTML = `
                    <div class="player p1">${m.p1}</div>
                    <div class="scores">
                        <input type="number" ${disabled} value="${m.s1 !== null ? m.s1 : ''}" oninput="updateScore(${m.idx}, 's1', this.value)">
                        <span style="color:#ccc;">-</span>
                        <input type="number" ${disabled} value="${m.s2 !== null ? m.s2 : ''}" oninput="updateScore(${m.idx}, 's2', this.value)">
                        ${hukmenHtml}
                        ${hukmenLabel}
                    </div>
                    <div class="player p2">${m.p2}</div>
                `;
                container.appendChild(card);
            });
        }
    }

    window.openTab = function(tabName) {
        document.querySelectorAll('.tab-content').forEach(t => { t.style.display = 'none'; t.classList.remove('active'); });
        document.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
        
        const selected = document.getElementById(tabName);
        selected.style.display = 'block';
        setTimeout(() => selected.classList.add('active'), 10);
        
        const btns = document.querySelectorAll('.navbar button');
        if(tabName === 'puanDurumu') btns[0].classList.add('active');
        if(tabName === 'fikstur') btns[1].classList.add('active');
        if(tabName === 'admin') btns[2].classList.add('active');
    }

    function showStatus(msg, type) {
        const bar = document.getElementById('statusBar');
        bar.innerText = msg;
        bar.style.background = type === 'success' ? '#27ae60' : '#e74c3c';
        bar.style.display = 'block';
        setTimeout(() => { bar.style.display = 'none'; }, 3000);
    }
</script>

</body>
</html>
