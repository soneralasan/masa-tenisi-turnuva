<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canlƒ± Masa Tenisi Turnuvasƒ±</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --light: #ecf0f1; --danger: #e74c3c; --win-bg: #d4edda; --lose-bg: #f8d7da; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background: #f0f2f5; color: #333; padding-bottom: 60px; }
        
        /* Navbar */
        .navbar { background: var(--primary); display: flex; justify-content: space-around; padding: 0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .navbar button { flex: 1; padding: 15px; background: transparent; border: none; color: #bdc3c7; font-size: 14px; font-weight: bold; cursor: pointer; transition: 0.3s; border-bottom: 4px solid transparent; }
        .navbar button.active { color: white; border-bottom: 4px solid var(--accent); background: rgba(255,255,255,0.05); }

        /* Container */
        .container { max-width: 900px; margin: 0 auto; padding: 10px; }
        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }

        /* Puan Tablosu */
        .table-container { overflow-x: auto; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); background: white; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 350px; }
        th, td { padding: 12px 8px; text-align: center; border-bottom: 1px solid #eee; font-size: 14px; }
        th { background: var(--primary); color: white; font-weight: 600; font-size: 12px; letter-spacing: 0.5px; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .top8 { background-color: #e8f5e9 !important; } 
        .top8 td:first-child { border-left: 4px solid var(--accent); font-weight: bold; color: var(--accent); }

        /* Fikst√ºr Kartlarƒ± */
        .day-header { text-align: center; margin: 25px 0 10px; font-weight: 800; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; font-size: 13px; position: relative; }
        .day-header::after { content: ''; display: block; width: 40px; height: 3px; background: var(--accent); margin: 5px auto 0; border-radius: 2px; }
        
        .match-card { background: white; padding: 10px; margin-bottom: 12px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; gap: 5px; }

        /* Bahis Alanƒ± */
        .vote-panel { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 45px; }
        .vote-btn { cursor: pointer; font-size: 18px; opacity: 0.6; transition: 0.2s; user-select: none; }
        .vote-btn:hover { opacity: 1; transform: scale(1.1); }
        .vote-btn.voted { color: var(--accent); opacity: 1; pointer-events: none; }
        .vote-percent { font-size: 10px; font-weight: bold; margin-top: 2px; }
        
        .text-green { color: var(--accent); }
        .text-red { color: var(--danger); }
        .text-grey { color: #aaa; }

        /* Oyuncu ƒ∞simleri */
        .player { flex: 1; font-weight: 600; font-size: 13px; word-wrap: break-word; line-height: 1.2; padding: 8px 5px; border-radius: 4px; transition: background 0.3s; }
        .player.p1 { text-align: right; }
        .player.p2 { text-align: left; }
        
        /* Kazanan/Kaybeden Arkaplanlarƒ± */
        .winner-bg { background-color: var(--win-bg); color: #155724; }
        .loser-bg { background-color: var(--lose-bg); color: #721c24; opacity: 0.8; }

        /* Skor Alanƒ± */
        .scores { display: flex; align-items: center; gap: 3px; justify-content: center; width: 80px; }
        .scores input { width: 28px; height: 28px; text-align: center; font-size: 15px; border: 1px solid #ddd; border-radius: 4px; font-weight: bold; background: #f9f9f9; }
        .scores input:focus { outline: none; border-color: var(--accent); background: white; }
        .scores input:disabled { background: #eee; color: #333; border: none; }

        /* H√ºkmen Butonu */
        .hukmen-toggle { width: 24px; height: 24px; border-radius: 4px; border: 1px solid #ccc; color: #777; font-size: 10px; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-left: 8px; user-select: none; background: #fff; transition: all 0.2s; }
        .hukmen-toggle.active { background: var(--danger); color: white; border-color: var(--danger); }
        .hukmen-indicator { font-size: 10px; color: var(--danger); font-weight: bold; margin-left: 5px; }

        /* Admin & Diƒüer */
        .admin-box { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; }
        .admin-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 5px; text-transform: uppercase; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-secondary { background: #34495e; color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .file-upload { background: #f1f1f1; padding: 15px; border-radius: 6px; margin-top: 15px; border: 2px dashed #ccc; }

        .status-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #333; color: white; padding: 12px; text-align: center; font-size: 13px; z-index: 2000; display: none; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        .error-box { background-color: #ffe6e6; border: 1px solid red; color: red; padding: 15px; margin: 10px; border-radius: 5px; display: none; text-align: center; font-weight: bold; }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @media (max-width: 600px) { .player { font-size: 12px; } .scores input { width: 24px; height: 24px; font-size: 13px; } .vote-btn { font-size: 16px; } }
    </style>
</head>
<body>

<div class="navbar">
    <button class="tab-link active" onclick="openTab('puanDurumu')">PUAN</button>
    <button class="tab-link" onclick="openTab('fikstur')">Fƒ∞KST√úR & BAHƒ∞S</button>
    <button class="tab-link" onclick="openTab('admin')">ADMƒ∞N</button>
</div>

<div class="container">
    <div id="loading" class="loader"></div>
    <div id="errorBox" class="error-box"></div> 

    <div id="puanDurumu" class="tab-content" style="display:none;">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th width="10%">#</th><th width="40%" style="text-align:left; padding-left:15px;">OYUNCU</th><th width="10%">O</th><th width="10%">G</th><th width="10%">M</th><th width="10%">AV</th><th width="10%">P</th>
                    </tr>
                </thead>
                <tbody id="standingsBody"></tbody>
            </table>
        </div>
        <p style="text-align:center; color:#7f8c8d; font-size:11px;">G:2, M:1, H√ºkmen:0 Puan</p>
    </div>

    <div id="fikstur" class="tab-content" style="display:none;">
        <div id="fixtureList"></div>
        <div id="saveBtnArea" style="margin-top:20px; display:none; position:sticky; bottom:20px;">
            <button class="btn btn-primary" style="box-shadow: 0 4px 10px rgba(0,0,0,0.3);" onclick="saveDataToFirebase()">üíæ SKORLARI KAYDET</button>
        </div>
    </div>

    <div id="admin" class="tab-content" style="display:none;">
        <div id="loginPanel" class="admin-box">
            <h2 style="color:var(--primary);">Y√∂netici Giri≈üi</h2>
            <input type="email" id="email" placeholder="E-Posta">
            <input type="password" id="password" placeholder="≈ûifre">
            <button class="btn btn-primary" onclick="login()">Giri≈ü Yap</button>
        </div>

        <div id="adminControls" class="admin-box" style="display:none;">
            <h3 style="color:var(--accent); margin-top:0;">Y√∂netim Paneli</h3>
            <div class="file-upload">
                <h4 style="margin:0 0 10px 0; color:#555;">Python Verisini Y√ºkle</h4>
                <input type="file" id="jsonFileInput" accept=".json" style="width:100%; margin-bottom:10px;">
                <button class="btn btn-secondary" onclick="importFromPythonJson()">üìÇ Y√úKLE VE YAYINLA</button>
            </div>
            <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">
            <input type="text" id="newPlayerName" placeholder="Yeni Oyuncu ƒ∞smi">
            <button class="btn btn-secondary" onclick="addPlayerTemp()">Listeye Ekle</button>
            <ul id="tempPlayerList" style="text-align:left; color:#555; font-size:13px;"></ul>
            <button class="btn btn-primary" style="margin-top:10px;" onclick="generateFixtureAndStart()">üöÄ MANUEL Lƒ∞Gƒ∞ BA≈ûLAT</button>
            <button class="btn btn-danger" onclick="firebase.auth().signOut()">√áƒ±kƒ±≈ü Yap</button>
        </div>
    </div>
</div>

<div id="statusBar" class="status-bar"></div>

<script>
    // ============================================================
    // 1. AYARLAR: KULLANICININ Y√úKLEDƒ∞ƒûƒ∞ DOSYADAKƒ∞ AYARLAR
    // ============================================================
    const firebaseConfig = {
        apiKey:  "AIzaSyApl74nGCJrG42BWFJaR_v3gqHGlF2R_3M",
        authDomain: "otomotiv-masa-tenisi-turnuvasi.firebaseapp.com",
        databaseURL: "https://otomotiv-masa-tenisi-turnuvasi-default-rtdb.firebaseio.com",
        projectId: "otomotiv-masa-tenisi-turnuvasi",
        storageBucket: "otomotiv-masa-tenisi-turnuvasi.firebasestorage.app",
        messagingSenderId: "88398060894",
        appId: "1:88398060894:web:8b9e4e1198466aae1283cf",
        measurementId: "G-GC6ND6CK6J"
    };

    // Firebase Ba≈ülat (Hata Yakalamalƒ±)
    try {
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    } catch (e) {
        document.getElementById('errorBox').style.display = 'block';
        document.getElementById('errorBox').innerText = "Firebase Ba≈ülatma Hatasƒ±: " + e.message;
    }
    const db = firebase.database();
    const auth = firebase.auth();

    // ============================================================
    // 2. STATE
    // ============================================================
    let appData = { players: [], matches: [], started: false };
    let tempPlayers = [];
    let isAdmin = false;

    window.onload = function() {
        auth.onAuthStateChanged(user => {
            isAdmin = !!user;
            document.getElementById('loginPanel').style.display = isAdmin ? 'none' : 'block';
            document.getElementById('adminControls').style.display = isAdmin ? 'block' : 'none';
            document.getElementById('saveBtnArea').style.display = isAdmin ? 'block' : 'none';
            if(isAdmin) showStatus("Y√∂netici modundasƒ±nƒ±z.", "success");
            // Tabloyu g√ºncelle (Kilitler a√ßƒ±lsƒ±n/kapansƒ±n)
            if(appData.started) renderFixture();
        });

        db.ref('turnuva').on('value', (snapshot) => {
            document.getElementById('loading').style.display = 'none';
            try {
                const data = snapshot.val();
                if (data) {
                    appData = data;
                    // Array/Object D√∂n√º≈ü√ºm√º (Kritik D√ºzeltme: Dizi olarak gelmezse diziye √ßevir)
                    if(data.players && !Array.isArray(data.players)) appData.players = Object.values(data.players);
                    if(data.matches && !Array.isArray(data.matches)) appData.matches = Object.values(data.matches);
                    
                    if(!appData.players) appData.players = [];
                    if(!appData.matches) appData.matches = [];
                    
                    calculateStandings();
                    renderFixture();
                    
                    if(document.querySelector('.tab-content.active') === null) openTab('puanDurumu');
                } else {
                    openTab('puanDurumu');
                    document.getElementById('fixtureList').innerHTML = '<p style="text-align:center; padding:20px; color:#999;">Veri yok. Y√∂netici panelinden veri y√ºkleyiniz.</p>';
                }
            } catch(e) {
                console.error(e);
                document.getElementById('errorBox').style.display = 'block';
                document.getElementById('errorBox').innerText = "Veri ƒ∞≈üleme Hatasƒ±: " + e.message;
            }
        }, (error) => {
            document.getElementById('errorBox').style.display = 'block';
            document.getElementById('errorBox').innerText = "Veritabanƒ± Eri≈üim Hatasƒ±: " + error.message;
        });
    };

    // ============================================================
    // 3. FONKSƒ∞YONLAR
    // ============================================================
    
    // G√úVENLƒ∞K: Deƒüer undefined/null ise bo≈ü string d√∂n (Bu fonksiyon hatayƒ± √ß√∂zer)
    function getSafeVal(val) {
        if (val === undefined || val === null) return "";
        return val;
    }

    function isValidScore(val) {
        return val !== null && val !== "" && val !== undefined && !isNaN(parseInt(val));
    }

    // BAHƒ∞S
    window.vote = function(matchIndex, side) {
        if(localStorage.getItem(`voted_match_${matchIndex}`)) return alert("Zaten oy kullandƒ±nƒ±z!");
        const ref = db.ref(`turnuva/matches/${matchIndex}/votes/${side}`);
        ref.transaction((currentValue) => (currentValue || 0) + 1)
            .then(() => localStorage.setItem(`voted_match_${matchIndex}`, 'true'))
            .catch(err => alert("Hata: " + err.message));
    }

    function calculateStandings() {
        if(!appData.players) return;
        appData.players.forEach(p => p.stats = { p:0, o:0, g:0, m:0, a:0, y:0, av:0 });

        if(appData.matches) {
            appData.matches.forEach(m => {
                if (isValidScore(m.s1) && isValidScore(m.s2)) {
                    // ƒ∞sim e≈üle≈ümesi yaparken trim() kullanmak g√ºvenli olabilir
                    const p1 = appData.players.find(pl => pl.name === m.p1);
                    const p2 = appData.players.find(pl => pl.name === m.p2);
                    if (p1 && p2) {
                        const s1 = parseInt(m.s1); const s2 = parseInt(m.s2);
                        p1.stats.o++; p2.stats.o++;
                        p1.stats.a += s1; p1.stats.y += s2;
                        p2.stats.a += s2; p2.stats.y += s1;
                        if (s1 > s2) {
                            p1.stats.g++; p1.stats.p += 2;
                            p2.stats.m++; p2.stats.p += m.hukmen ? 0 : 1;
                        } else if (s2 > s1) {
                            p2.stats.g++; p2.stats.p += 2;
                            p1.stats.m++; p1.stats.p += m.hukmen ? 0 : 1;
                        }
                    }
                }
            });
        }

        appData.players.forEach(p => p.stats.av = (p.stats.a||0) - (p.stats.y||0));
        appData.players.sort((a, b) => {
            if (b.stats.p !== a.stats.p) return b.stats.p - a.stats.p;
            if (b.stats.av !== a.stats.av) return b.stats.av - a.stats.av;
            return b.stats.a - a.stats.a;
        });
        renderStandings();
    }

    // RENDER: Puan Durumu
    function renderStandings() {
        const tbody = document.getElementById('standingsBody');
        if(!tbody) return;
        tbody.innerHTML = '';
        if(!appData.players) return;
        appData.players.forEach((p, index) => {
            tbody.innerHTML += `
                <tr class="${index < 8 ? 'top8' : ''}">
                    <td>${index + 1}</td>
                    <td style="text-align:left; padding-left:15px; font-weight:600;">${p.name}</td>
                    <td>${p.stats.o}</td><td>${p.stats.g}</td><td>${p.stats.m}</td><td>${p.stats.av}</td><td><strong>${p.stats.p}</strong></td>
                </tr>`;
        });
    }

    // RENDER: Fikst√ºr
    function renderFixture() {
        const container = document.getElementById('fixtureList');
        if(!container) return;
        if(document.activeElement.tagName === "INPUT") return;
        
        container.innerHTML = '';
        if (!appData.matches || appData.matches.length === 0) {
            container.innerHTML = '<p style="text-align:center;">Ma√ß yok.</p>'; return;
        }

        const rounds = {};
        appData.matches.forEach((m, index) => {
            if (!rounds[m.round]) rounds[m.round] = [];
            rounds[m.round].push({ ...m, idx: index });
        });

        for (const [round, matches] of Object.entries(rounds)) {
            const header = document.createElement('div');
            header.className = 'day-header';
            header.innerText = `${round}. G√úN`;
            container.appendChild(header);

            matches.forEach(m => {
                const card = document.createElement('div');
                card.className = 'match-card';
                const disabled = isAdmin ? '' : 'disabled';
                
                // Bahis & Renk
                let v1 = (m.votes && m.votes.p1) ? m.votes.p1 : 0;
                let v2 = (m.votes && m.votes.p2) ? m.votes.p2 : 0;
                let totalVotes = v1 + v2;
                let p1_pct = totalVotes === 0 ? 0 : Math.round((v1 / totalVotes) * 100);
                let p2_pct = totalVotes === 0 ? 0 : Math.round((v2 / totalVotes) * 100);
                let p1_color = p1_pct > p2_pct ? 'text-green' : (p1_pct < p2_pct ? 'text-red' : 'text-grey');
                let p2_color = p2_pct > p1_pct ? 'text-green' : (p2_pct < p1_pct ? 'text-red' : 'text-grey');
                if(totalVotes===0) { p1_color='text-grey'; p2_color='text-grey'; }
                const isVoted = localStorage.getItem(`voted_match_${m.idx}`);
                const voteClass = isVoted ? 'voted' : '';

                // Kazanan/Kaybeden Rengi
                let p1_bg = '', p2_bg = '';
                if(isValidScore(m.s1) && isValidScore(m.s2)) {
                    if(parseInt(m.s1) > parseInt(m.s2)) { p1_bg = 'winner-bg'; p2_bg = 'loser-bg'; }
                    else if(parseInt(m.s2) > parseInt(m.s1)) { p2_bg = 'winner-bg'; p1_bg = 'loser-bg'; }
                }

                let hukmenBtn = '', hukmenLabel = '';
                if(isAdmin) {
                    const activeClass = m.hukmen ? 'active' : '';
                    hukmenBtn = `<div class="hukmen-toggle ${activeClass}" onclick="toggleHukmen(${m.idx})">H</div>`;
                }
                if(m.hukmen && !isAdmin) {
                     hukmenLabel = '<span class="hukmen-indicator" style="position:static; margin-left:5px;">(H√úKMEN)</span>';
                }

                // G√úVENLƒ∞ INPUT VALUE: getSafeVal kullanƒ±mƒ±
                card.innerHTML = `
                    <div class="vote-panel">
                        <div class="vote-percent ${p1_color}">${totalVotes>0 ? p1_pct+'%' : ''}</div>
                        <div class="vote-btn ${voteClass}" onclick="vote(${m.idx}, 'p1')">üëç</div>
                    </div>
                    <div class="player p1 ${p1_bg}">${m.p1}</div>
                    <div style="display:flex; flex-direction:column; align-items:center;">
                        <div class="scores">
                            <input type="text" inputmode="numeric" ${disabled} value="${getSafeVal(m.s1)}" oninput="updateScore(${m.idx},'s1',this.value)">
                            <span>-</span>
                            <input type="text" inputmode="numeric" ${disabled} value="${getSafeVal(m.s2)}" oninput="updateScore(${m.idx},'s2',this.value)">
                        </div>
                        ${hukmenLabel} ${hukmenBtn}
                    </div>
                    <div class="player p2 ${p2_bg}">${m.p2}</div>
                    <div class="vote-panel">
                        <div class="vote-percent ${p2_color}">${totalVotes>0 ? p2_pct+'%' : ''}</div>
                        <div class="vote-btn ${voteClass}" onclick="vote(${m.idx}, 'p2')">üëç</div>
                    </div>
                `;
                container.appendChild(card);
            });
        }
    }

    // --- Standart Fonksiyonlar ---
    function login() { auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value).catch(e=>alert(e.message)); }
    function addPlayerTemp() { 
        let name = document.getElementById('newPlayerName').value.trim();
        if(name) { tempPlayers.push({name:name, stats:{}}); document.getElementById('newPlayerName').value=''; document.getElementById('tempPlayerList').innerHTML=tempPlayers.map(p=>`<li>${p.name}</li>`).join(''); }
    }
    function generateFixtureAndStart() {
        if(tempPlayers.length<2) return alert("En az 2 oyuncu.");
        if(!confirm("Eski veriler silinecek.")) return;
        let players = [...tempPlayers]; if(players.length%2!==0) players.push(null);
        let matches = [];
        for(let r=0; r<players.length-1; r++) {
            for(let i=0; i<players.length/2; i++) {
                let p1=players[i], p2=players[players.length-1-i];
                if(p1&&p2) matches.push({round:r+1, p1:p1.name, p2:p2.name, s1:null, s2:null, hukmen:false, votes:{p1:0,p2:0}});
            }
            players.splice(1,0,players.pop());
        }
        db.ref('turnuva').set({players:tempPlayers, matches:matches, started:true}).then(()=>{ tempPlayers=[]; openTab('fikstur'); });
    }
    function importFromPythonJson() {
        const file = document.getElementById('jsonFileInput').files[0];
        if (!file) return alert("Dosya se√ßin.");
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const pyData = JSON.parse(e.target.result);
                if (!pyData.oyuncular || !pyData.maclar) return alert("Hatalƒ± dosya.");
                if(!confirm("Eski veriler silinecek.")) return;
                const newPlayers = pyData.oyuncular.map(name => ({ name: name, stats: { p:0,o:0,g:0,m:0,a:0,y:0,av:0 } }));
                const newMatches = pyData.maclar.map(m => ({
                    round: m.gun, p1: m.p1, p2: m.p2,
                    s1: isValidScore(m.s1) ? parseInt(m.s1) : null,
                    s2: isValidScore(m.s2) ? parseInt(m.s2) : null,
                    hukmen: m.hukmen || false, votes: { p1:0, p2:0 }
                }));
                appData = { players: newPlayers, matches: newMatches, started: true };
                db.ref('turnuva').set(appData).then(() => { alert("Y√ºklendi!"); openTab('puanDurumu'); });
            } catch (error) { alert("Hata: " + error); }
        };
        reader.readAsText(file);
    }
    window.updateScore = function(i,f,v) { if(isAdmin) appData.matches[i][f] = v===''?null:parseInt(v); }
    window.toggleHukmen = function(i) { if(isAdmin) { appData.matches[i].hukmen = !appData.matches[i].hukmen; renderFixture(); } }
    window.saveDataToFirebase = function() { if(isAdmin) { calculateStandings(); db.ref('turnuva').update(appData).then(()=>showStatus("Kaydedildi!","success")); } }
    window.openTab = function(t) { 
        document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active')); 
        document.querySelectorAll('.tab-link').forEach(e=>e.classList.remove('active')); 
        const target = document.getElementById(t);
        if(target) {
            target.classList.add('active'); 
            const idx = t=='puanDurumu'?0:t=='fikstur'?1:2;
            document.querySelectorAll('.navbar button')[idx].classList.add('active'); 
        }
    }
    function showStatus(m,t) { let b=document.getElementById('statusBar'); b.innerText=m; b.style.background=t=='success'?'#27ae60':'#e74c3c'; b.style.display='block'; setTimeout(()=>b.style.display='none',3000); }
</script>

</body>
</html>
